<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.herodotus.eurynome.bpmn.logic.mapper.HistoryActivityInstanceRepository">
    <delete id="deleteHistoryActivityInstance" parameterType="java.lang.String">
        WITH activity_flag AS (SELECT t1.*
                               FROM act_hi_actinst t1
                               WHERE t1.proc_inst_id_ = #{processInstanceId}
                                 AND t1.act_id_ = #{activityInstanceId}
                               ORDER BY t1.end_time_ ASC)
        DELETE
        FROM act_hi_actinst aha USING activity_flag af
        WHERE aha.proc_inst_id_ = af.proc_inst_id_
          AND (
                aha.end_time_ > af.end_time_
                OR aha.end_time_ IS NULL)
    </delete>
</mapper>
